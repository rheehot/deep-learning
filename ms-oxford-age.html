<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: xwMOOC 딥러닝</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    
    <!--
    <div id="google_translate_element"></div><script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'ko', includedLanguages: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
    }
    </script><script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    -->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">xwMOOC 딥러닝</h1></a>
          <h2 class="subtitle">사진속 나이 추정</h2>
          <section class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="학습-목표"><span class="glyphicon glyphicon-certificate"></span>학습 목표</h2>
</div>
<div class="panel-body">
<ul>
<li>실제 나이와 사진 속 나이 차이를 수치화한다.</li>
<li>인공지능 API를 활용하여 사진속 나이를 추정한다.</li>
<li>수많은 사진자료작업을 작업화하는 깨알같은 기법을 학습한다.</li>
</ul>
</div>
</section>
<h2 id="연령추정-작업흐름-pictures-with-age-info">1. 연령추정 작업흐름 <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></h2>
<p>사진속 연령추정을 위한 작업흐름은 먼저 연령을 추정할 데이터를 구하고 나서, 이를 R로 불러 읽어들인다. 다양한 인공지능 API가 있어 연령추정기능을 제공하는 API를 찾아 이곳에 보낼 수 있는 자료형으로 이미지 데이터를 준비한다. 인공지능 API에 전달하기 전에 이미지 데이터에 대한 기초 분석과 더불어 탐색적 데이터 분석 및 데이터 정제작업을 거친다.</p>
<p>정제된 이미지 데이터가 준비되면 이를 API에 던져 이미지속 성별과 나이결과값을 받아 온다. 그리고 나면 기존 이미지 데이터와 더불어 애니메이션 제작, 인터랙티브 데이터 분석을 포함한 심도깊은 작업을 수행한다.</p>
<p><img src="fig/ms-cognitive-age.png" alt="연령 추정 데이터분석 아키텍쳐" width="57%" /></p>
<p>연령추정에 사용될 이미지 데이터는 <a href="http://news.naver.com/main/read.nhn?mode=LSD&amp;mid=sec&amp;sid1=100&amp;oid=028&amp;aid=0002342652">2004년부터 2016년까지 촬영된 박 대통령 사진 비교</a> 기사에 올라온 이미지를 다운로드받는다. 다운로드받은 이미지 데이터는 원본데이터로 <code>03.data/</code> 같은 폴더를 별로 만들어서 저장하고 안전하게 보관한다. 만약 문제가 발생되게 되면, 다시 원본 이미지를 분석작업에 활용한다.</p>
<h2 id="r에서-이미지-기본작업-r-magick">2. R에서 이미지 기본작업 <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></h2>
<p>R에서 이미지 분석에 필요한 팩키지를 설치하고 나서 작업환경에 불러온다. 개별적으로 이미지를 <code>magick::image_read</code> 명령어를 통해서 불러오는 것은 사람보다 기계가 더 잘 하는 작업으로 R에서 자주 활용되는 기법을 활용하여 통째로 불러온다.</p>
<ol style="list-style-type: decimal">
<li>개별적으로 불러와서 작업한 결과를 담을 통을 준비: <code>img_info_bucket &lt;- list()</code></li>
<li>개별적으로 작업할 이미지 파일 목록을 생성: <code>list.files(&quot;03_data/&quot;)</code></li>
<li>반복문을 간결하게 생성: <code>seq_along()</code> 함수 사용</li>
<li>반복작업 결과를 집계: <code>do.call(rbind, img_info_bucket)</code></li>
</ol>
<p>전형적인 <a href="https://statkclee.github.io/r-novice-gapminder/12-plyr-kr.html">분할-적용-병합(split-apply-combine) 전략</a>의 대표적인 적용사례다.</p>
<h3 id="이미지-정보-확인">1.1. 이미지 정보 확인</h3>
<p>이미지를 불러와서 가장 먼저 할 작업은 데이터프레임을 통해 이미지 데이터 정보를 살펴보는 것이다. 다행히 이미지 파일 형식(<strong>JPEG</strong>)과 넓이와 높이가 모두 동일하고 파일크기만 일부 차이가 나는 것이 확인된다. 따라서, 별도 전처리 작업은 필요하지 않게 되었다. 기사의 사진 자료를 준비해주신 분께 깊은 감사의 말씀을 전한다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 0. 환경설정--------------------------------------------------</span>
<span class="kw">library</span>(httr)
<span class="kw">library</span>(XML)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(png)
<span class="kw">library</span>(grid)
<span class="kw">library</span>(jsonlite)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(lubridate)
<span class="kw">library</span>(magick)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(grid)

<span class="co"># 1. 데이터 불러오기 ----------------------------------------------</span>

img_list &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;03_data/&quot;</span>) 
img_list &lt;-<span class="st"> </span>stringr::<span class="kw">str_replace</span>(img_list, <span class="st">&quot;.jpg&quot;</span>, <span class="st">&quot;&quot;</span>)

img_info_bucket &lt;-<span class="st"> </span><span class="kw">list</span>()

<span class="co"># 2. 사진 정보 확인 ------------------------------------------------</span>
<span class="co"># https://cran.r-project.org/web/packages/magick/vignettes/intro.html</span>
for(lst in <span class="kw">seq_along</span>(img_list)){
  tmp &lt;-<span class="st"> </span><span class="kw">image_read</span>(<span class="kw">paste0</span>(<span class="st">&quot;03_data/&quot;</span>, img_list[lst], <span class="st">&quot;.jpg&quot;</span>))
  img_info_bucket[[lst]] &lt;-<span class="st"> </span><span class="kw">image_info</span>(tmp)
}

img_info_buckets &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, img_info_bucket)

img_info_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">idate =</span> <span class="kw">substr</span>(<span class="kw">as.vector</span>(img_list), <span class="dv">5</span>,<span class="dv">13</span>), img_info_buckets)

img_info_df
##       idate format width height colorspace filesize
## 1  20040414   JPEG   540    720       sRGB   275964
## 2  20040723   JPEG   540    720       sRGB   241867
## 3  20090702   JPEG   540    720       sRGB   266427
## 4  20110603   JPEG   540    720       sRGB   237164
## 5  20120508   JPEG   540    720       sRGB   261189
## 6  20121108   JPEG   540    720       sRGB   234499
## 7  20121224   JPEG   540    720       sRGB   240137
## 8  20130529   JPEG   540    720       sRGB   277783
## 9  20140113   JPEG   540    720       sRGB   267968
## 10 20140724   JPEG   540    720       sRGB   241137
## 11 20141229   JPEG   540    720       sRGB   183747
## 12 20150504   JPEG   540    720       sRGB   229414
## 13 20150804   JPEG   540    720       sRGB   218613
## 14 20160204   JPEG   540    720       sRGB   238201
## 15 20161104   JPEG   540    720       sRGB   221589

<span class="kw">summary</span>(img_info_df)

##    idate              format              width         height     colorspace           filesize     
## Length:15          Length:15          Min.   :540   Min.   :720   Length:15          Min.   :183747  
## Class :character   Class :character   1st Qu.:540   1st Qu.:720   Class :character   1st Qu.:231957  
## Mode  :character   Mode  :character   Median :540   Median :720   Mode  :character   Median :240137  
##                                       Mean   :540   Mean   :720                      Mean   :242380  
##                                       3rd Qu.:540   3rd Qu.:720                      3rd Qu.:263808  
##                                       Max.   :540   Max.   :720                      Max.   :277783  </code></pre></div>
<h3 id="사진-가로로-붙이기">1.2. 사진 가로로 붙이기</h3>
<p>이제 전체 이미지 데이터가 제대로 들어왔는지 다시 한번 시각적으로 확인한다. 개별 파일을 열어서 확인할 수도 있지만, <code>image_append</code> 함수 기능을 사용해서 데이터를 확인한다. 기본설정은 가로방향으로 쭉 붙게 되고, <code>stack = TRUE</code> 인자를 넘기면 수직으로 쭉 쌓는 것도 가능하다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 3. 이미지 쫙 붙이기 ------------------------------------------------</span>
<span class="co"># 전체 이미지 불러오기</span>
for(lst in <span class="kw">seq_along</span>(img_list)){
  img_name &lt;-<span class="st"> </span>img_list[lst]
  <span class="kw">assign</span>(img_name, <span class="kw">image_read</span>(<span class="kw">paste0</span>(<span class="st">&quot;03_data/&quot;</span>, img_list[lst], <span class="st">&quot;.jpg&quot;</span>)))
}

img_vec &lt;-<span class="st"> </span><span class="kw">c</span>(img_20040414, img_20040723, img_20090702, img_20110603, 
             img_20120508, img_20121108, img_20121224, img_20130529, 
             img_20140113, img_20140724, img_20141229, img_20150504,
             img_20150804, img_20160204, img_20161104)


img_left2right &lt;-<span class="st"> </span><span class="kw">image_append</span>(<span class="kw">image_scale</span>(img_vec, <span class="st">&quot;x77&quot;</span>))

<span class="kw">image_write</span>(img_left2right, <span class="st">&quot;04.result/left2right.png&quot;</span>, <span class="dt">format =</span> <span class="st">&quot;png&quot;</span>)

img_top2bottom &lt;-<span class="st"> </span><span class="kw">image_append</span>(<span class="kw">image_scale</span>(img_vec, <span class="st">&quot;x77&quot;</span>), <span class="dt">stack =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="fig/left2right.png" alt="이미지 사진 가로로 쭉 붙이기" width="100%" /></p>
<h3 id="애니메이션-만들기">1.3. 애니메이션 만들기</h3>
<p>이미지를 생성시킨 다음에 가장 나이가 적은 사진과 가장 나이가 많은 사진을 뽑아 <code>image_morph()</code> 기능을 통해 10년이 넘는 동안 얼굴변화과정을 <code>.gif</code> 파일로 변환하여 동적인 시간정보를 담아 낸다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 이미지 좌우 반전</span>
img_20161104 &lt;-<span class="st"> </span><span class="kw">image_flop</span>(img_20161104)

img_transition &lt;-<span class="st"> </span><span class="kw">image_morph</span>(<span class="kw">c</span>(img_20161104, img_20161104), <span class="dt">frames =</span> <span class="dv">10</span>)
img_animation &lt;-<span class="st"> </span><span class="kw">image_animate</span>(img_transition, <span class="dt">fps=</span><span class="dv">5</span>)

<span class="kw">image_write</span>(img_animation, <span class="st">&quot;04.result/img_transition.gif&quot;</span>)</code></pre></div>
<p><img src="fig/img_transition.gif" alt="얼굴 변화 애니메이션" width="57%" /></p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="http://news.naver.com/main/read.nhn?mode=LSD&amp;mid=sec&amp;sid1=100&amp;oid=028&amp;aid=0002342652">2004년부터 2016년까지 촬영된 박 대통령 사진 비교</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p><a href="https://cran.r-project.org/web/packages/magick/vignettes/intro.html">The magick package: Advanced Image-Processing in R</a><a href="#fnref2">↩</a></p></li>
</ol>
</div>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/lesson-template">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-37305346-2', 'auto');
      ga('send', 'pageview');
    
    </script>
  </body>
</html>
