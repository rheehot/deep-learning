---
title: "딥러닝"
subtitle: "이미지 객체 분류 시스템 (Object Classification)"
author:
  - name: "[Tidyverse Korea](https://www.facebook.com/groups/tidyverse/)"
    url: https://www.facebook.com/groups/tidyverse/
    affiliation: Tidyverse Korea
    affiliation_url: https://www.facebook.com/groups/tidyverse/
date: "`r Sys.Date()`"
output:
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: true
    highlight: tango
    code_folding: show
    number_section: true
    self_contained: true
bibliography: bibliography.bib
csl: biomed-central.csl
urlcolor: blue
linkcolor: blue
editor_options: 
  chunk_output_type: console
---

``` {r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      comment="", digits = 3, tidy = FALSE, prompt = FALSE, fig.align = 'center')

knitr::opts_knit$set(global.par = TRUE) 
```

# 객체 분류 {#object-classification}

[ImageNet Classification](https://pjreddie.com/darknet/imagenet/) 분류기는 [Large Scale Visual Recognition Challenge 2015 (ILSVRC2015)](http://image-net.org/challenges/LSVRC/2015/index)에 등재된 1,000개 객체(Image Object)를 정확히 분류하는 것을 목표로 한다. 정확도를 높이고자 그동안 많은 노력이 경주되어 왔다.

- AlexNet: <http://pjreddie.com/media/files/alexnet.weights>
- Darknet Reference Model: <http://pjreddie.com/media/files/darknet.weights>
- VGG-16: <http://pjreddie.com/media/files/vgg-16.weights>
- Googlenet/extraction: <http://pjreddie.com/media/files/extraction.weights>
- Darknet19: <http://pjreddie.com/media/files/extraction.weights>
- Darknet19 448x448: <http://pjreddie.com/media/files/darknet19_448.weights>


```{r imagenet-performance}
library(rvest)
library(tidyverse)

darknet_url <- "https://pjreddie.com/darknet/imagenet/"

comparison_table <- darknet_url %>% 
  read_html() %>% 
  html_node(css = '#compare') %>% 
  html_table()

comparison_table %>% 
  tbl_df() %>% 
  set_names(c("Model", "Top-1", "Top-5", "Ops(Bn)", "GPU(ms)", "CPU(s)", "Cfg", "Weights(MB)")) %>% 
  janitor::clean_names() %>% 
  mutate_at(vars("ops_bn", "gpu_ms", "cpu_s", "weights_mb"), parse_number) %>% 
  DT::datatable()
```

# 객체 분류기: `AlexNet` {#object-classification-alexnet}

`AlexNet`[@krizhevsky2012imagenet]을 활용하여 이미지에 포함된 객체를 분류해보자.

먼저, 이미지에 포함된 객체를 식별하는데 사용될 사진들을 살펴보자.

```{r image-clasify}
library(tidyverse)
library(magick)
library(image.darknet)

trilobite <- image_read("fig/trilobite.jpg") %>% image_resize(100)
airplane <- image_read("fig/airplane.jpeg") %>% image_resize(100)
wagon <- image_read("fig/wagon.jpg")  %>% image_resize(100)
경복궁 <- image_read("fig/경복궁.jpg")  %>% image_resize(100)
설악산 <- image_read("fig/설악산.png") %>% image_resize(100)
bear <- image_read("fig/bear.jpg") %>% image_resize(100)
elephant <- image_read("fig/imagenet-transfer-learning-setup-1.png")  %>% image_resize(100)

image_append(c(trilobite, airplane, wagon, 경복궁, 설악산, bear, elephant), stack = FALSE)
```

AlexNet을 다운로드 받아 사전 훈련된 모형(Pre-Trained Model)을 사용해서 이미지를 분류해보자.

```{r image-darknet-alexnet, eval = FALSE}
library(image.darknet)

# download.file(url = "https://pjreddie.com/media/files/alexnet.weights", destfile = "DL_library/alexnet.weights")
# download.file(url = "https://pjreddie.com/media/files/darknet.weights", destfile = "DL_library/darknet.weights")

## ImageNet 라벨
labels <- readLines(system.file(package="image.darknet", "include", "darknet", "data", "imagenet.shortnames.list"))

## AlexNet ....................................................................
### http://pjreddie.com/media/files/alexnet.weights

alexnet_weights <- "DL_library/alexnet.weights"

alexnet <- image_darknet_model(type = 'classify', 
                               model = "DL_library/alexnet.cfg", 
                               weights = alexnet_weights, 
                               labels = labels, 
                               resize = FALSE) # FALSE 값 설정 Alexnnet, VGG-16

image_darknet_classify(file = "fig/airplane.jpeg", object = alexnet)
```

# 객체 분류기: `Darknet 19` {#object-classification-resnet}

Darknet19를 사용해서 동일하게 분류해보자.

```{r resnet-classification}
# ImageNet 라벨
labels <- readLines(system.file(package="image.darknet", "include", "darknet", "data", "imagenet.shortnames.list"))

darknet19_weights <- "DL_library/darknet19.weights"

darknet19 <- image_darknet_model(type = 'classify', 
                                 model = "DL_library/darknet19.cfg",
                                 weights = darknet19_weights, 
                                 labels = labels)

image_darknet_classify(file = "fig/airplane.jpeg", object = darknet19)

```

# 자동화 {#automate-classification}

```{r automate-classification-for-loop}
library(tidyverse)

# ImageNet 라벨
labels <- readLines(system.file(package="image.darknet", "include", "darknet", "data", "imagenet.shortnames.list"))

# Pretrained Model
# pretrained_models <- c("darknet", "darknet19", "densenet201", "resnet101")
pretrained_models <- c("darknet", "densenet201")

## darknet
darknet_weights <- "DL_library/darknet.weights"

darknet <- image_darknet_model(type = 'classify', 
                                 model = "DL_library/darknet.cfg",
                                 weights = darknet_weights, 
                                 labels = labels)

## densenet201
densenet201_weights <- "DL_library/densenet201.weights"

densenet201 <- image_darknet_model(type = 'classify', 
                                 model = "DL_library/densenet201.cfg",
                                 weights = densenet201_weights, 
                                 labels = labels)


models_summary <- tibble(model = pretrained_models,
                         probability = 0,
                         label = "x")

for(i in 1:length(pretrained_models)){
  x <- image_darknet_classify(file = "fig/airplane.jpeg",
                              object = get(pretrained_models[i]))
  models_summary$probability[i] <- x$type$probability[1]
  models_summary$label[i] <- x$type$label[1]
}

models_summary %>% 
  arrange(desc(probability))

```

